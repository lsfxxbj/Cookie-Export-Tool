# 国际化文档

## 目录

- [概述](#概述)
- [支持的语言](#支持的语言)
- [语言检测和切换](#语言检测和切换)
- [翻译资源管理](#翻译资源管理)
- [本地化实现](#本地化实现)
- [添加新语言](#添加新语言)
- [最佳实践](#最佳实践)

## 概述

Cookie Exporter 扩展支持多语言界面，旨在为全球用户提供友好的使用体验。项目采用现代的国际化（i18n）和本地化（l10n）实践，通过模块化的设计实现灵活的语言支持。

## 支持的语言

目前项目支持以下三种语言：

1. **中文 (zh-CN)** - 简体中文
2. **英文 (en)** - 英语
3. **法文 (fr)** - 法语

语言选择基于用户的浏览器语言设置，同时允许用户手动切换语言。

## 语言检测和切换

### 自动语言检测

扩展会自动检测用户的浏览器语言设置，并根据以下优先级选择默认语言：

1. 如果浏览器语言在支持列表中，则使用该语言
2. 如果浏览器语言以 "zh" 开头，则使用中文
3. 其他情况默认使用英文

相关代码实现在 [popupInitializer.js](../js/modules/popupInitializer.js) 中：

```javascript
// 首先尝试从存储中获取语言设置，如果没有则使用浏览器默认语言
UserConfig.getLanguage(function(savedLanguage) {
  if (!savedLanguage) {
    // 获取浏览器UI语言
    const browserLanguage = chrome.i18n.getUILanguage();
    
    // 根据浏览器语言设置默认语言
    const supportedLanguages = I18n.getSupportedLanguages();
    if (supportedLanguages.includes(browserLanguage)) {
      savedLanguage = browserLanguage;
    } else if (browserLanguage.startsWith('zh')) {
      savedLanguage = 'zh-CN';
    } else {
      // 默认使用英语
      savedLanguage = 'en';
    }
    
    // 保存语言设置
    UserConfig.setLanguage(savedLanguage);
  }
  
  // 设置语言选择器的值
  languageSelector.value = savedLanguage;
  
  // 应用界面本地化设置
  LocalizationManager.applyLocalization(languageSelector, () => CookieCounter.updateCookieCount(cookieCount));
});
```

### 手动语言切换

用户可以通过界面顶部的语言选择器手动切换语言。语言切换功能实现在 [popupInitializer.js](../js/modules/popupInitializer.js) 中：

```javascript
/**
 * 切换语言
 */
function changeLanguage(languageSelector, cookieCount) {
  const selectedLanguage = languageSelector.value;
  console.log('Changing language to:', selectedLanguage);
  
  // 保存语言设置到存储中
  UserConfig.setLanguage(selectedLanguage, function() {
    console.log('Language setting saved: ' + selectedLanguage);
  });
  
  // 重新应用本地化来更新界面文本
  LocalizationManager.applyLocalization(languageSelector, () => CookieCounter.updateCookieCount(cookieCount));
  console.log('Localization applied');
  
  // 显示语言切换成功的消息
  const lang = languageSelector.value;
  const langNames = {
    'zh-CN': I18n.getMessage("chinese"),
    'en': I18n.getMessage("english"),
    'fr': I18n.getMessage("french")
  };
  const resultDiv = DOMManager.getResultDiv();
  if (resultDiv) UIManager.showResult(`${I18n.getMessage("languageChanged")} ${langNames[lang] || lang}`, 'success', resultDiv);
  setTimeout(() => {
    const resultDiv = DOMManager.getResultDiv();
    if (resultDiv) resultDiv.classList.remove('visible');
  }, 1500);
}
```

## 翻译资源管理

翻译资源通过两种方式管理：

### 1. Chrome 扩展标准格式

在 [_locales](../_locales/) 目录下，每种语言都有对应的子目录，包含 [messages.json](../_locales/zh_CN/messages.json) 文件：

```
_locales/
├── zh_CN/
│   └── messages.json
├── en/
│   └── messages.json
└── fr/
    └── messages.json
```

每个 [messages.json](../_locales/zh_CN/messages.json) 文件包含键值对形式的翻译资源：

```json
{
  "extensionName": {
    "message": "Cookie 导出工具"
  },
  "exportTab": {
    "message": "导出"
  }
}
```

### 2. 自定义翻译映射

在 [js/modules/localization/translations.js](../js/modules/localization/translations.js) 中，维护了一个 JavaScript 对象形式的翻译映射表：

```javascript
export const translations = {
  "zh-CN": {
    "extensionName": "Cookie 导出工具",
    "exportTab": "导出"
  },
  "en": {
    "extensionName": "Cookie Export Tool",
    "exportTab": "Export"
  },
  "fr": {
    "extensionName": "Outil d'exportation de cookies",
    "exportTab": "Exporter"
  }
};
```

这种方式主要用于运行时的动态翻译和一些特殊的本地化需求。

## 本地化实现

本地化通过 [I18nManager](../js/modules/i18n/i18nManager.js) 模块实现，主要包括以下几个方面：

### 1. HTML 元素本地化

使用 `data-i18n` 属性标记需要本地化的元素：

```html
<button id="export-current-btn" data-i18n="exportCurrent">导出当前网站 Cookie</button>
<span id="cookie-count" data-i18n="cookieCountInitialText">Cookies: 0</span>
```

### 2. 占位符本地化

使用 `data-i18n-placeholder` 属性标记需要本地化占位符的输入元素：

```html
<input type="text" id="domain-filter" data-i18n-placeholder="domainFilterPlaceholder" placeholder="例如: example.com">
```

### 3. ARIA 标签本地化

使用 `data-i18n-aria-label` 属性标记需要本地化 aria-label 的元素：

```html
<select id="format-select" data-i18n-aria-label="exportFormatAriaLabel">
  <option value="json" data-i18n="jsonFormat">JSON</option>
  <option value="csv" data-i18n="csvFormat">CSV</option>
</select>
```

### 4. 本地化应用函数

[I18nManager.applyLocalization()](file:///C:/Users/82490/Desktop/PythonProject/js/modules/i18n/i18nManager.js) 函数负责应用本地化：

```javascript
/**
 * 应用本地化到界面元素
 * @param {HTMLElement} languageSelector - 语言选择器元素
 * @param {Function} updateCookieCountFunction - 更新 Cookie 计数的函数
 */
function applyLocalization(languageSelector, updateCookieCountFunction) {
  console.log('Applying localization');
  // 获取当前选择的语言
  const currentLanguage = languageSelector.value;
  console.log('Current selected language:', currentLanguage);
  
  // 本地化所有带有 data-i18n 属性的元素
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    const message = getLocalizedMessage(key, currentLanguage);
    console.log('Localizing element:', element, 'Key:', key, 'Message:', message);
    if (message) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = message;
      } else if (element.tagName === 'TITLE') {
        // 特殊处理标题元素
        document.title = message;
      } else if (element.tagName === 'OPTION') {
        // 特殊处理选项元素
        element.textContent = message;
      } else {
        // 对于普通元素，直接更新 textContent
        element.textContent = message;
        console.log('Updated element content to', message);
      }
    }
  });
  
  // 本地化select元素内部的选项
  document.querySelectorAll('select[data-i18n-aria-label]').forEach(select => {
    select.querySelectorAll('option[data-i18n]').forEach(option => {
      const key = option.getAttribute('data-i18n');
      const message = getLocalizedMessage(key, currentLanguage);
      if (message) {
        option.textContent = message;
      }
    });
  });
  
  // 本地化 placeholder
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    const message = getLocalizedMessage(key, currentLanguage);
    if (message) {
      element.placeholder = message;
    }
  });
  
  // 本地化 aria-label 属性
  document.querySelectorAll('[data-i18n-aria]').forEach(element => {
    const key = element.getAttribute('data-i18n-aria');
    const message = getLocalizedMessage(key, currentLanguage);
    if (message) {
      element.setAttribute('aria-label', message);
    }
  });
  
  // 本地化 aria-label 属性（使用 data-i18n-aria-label）
  document.querySelectorAll('[data-i18n-aria-label]').forEach(element => {
    const key = element.getAttribute('data-i18n-aria-label');
    const message = getLocalizedMessage(key, currentLanguage);
    if (message) {
      element.setAttribute('aria-label', message);
    }
  });
  
  // 更新HTML的lang属性
  document.documentElement.lang = currentLanguage;
  
  // 更新 Cookie 计数
  if (updateCookieCountFunction) {
    updateCookieCountFunction();
  }
}
```

## 添加新语言

要添加新语言支持，需要执行以下步骤：

### 1. 创建语言目录

在 [_locales](../_locales/) 目录下创建新语言的子目录，例如 `es` 表示西班牙语。

### 2. 创建消息文件

在新创建的语言目录中创建 [messages.json](../_locales/zh_CN/messages.json) 文件，包含所有翻译键值对：

```json
{
  "extensionName": {
    "message": "Herramienta de Exportación de Cookies"
  },
  "exportTab": {
    "message": "Exportar"
  }
}
```

### 3. 更新翻译映射

在 [js/modules/localization/translations.js](../js/modules/localization/translations.js) 中添加新语言的翻译映射：

```javascript
export const translations = {
  // ... 其他语言
  "es": {
    "extensionName": "Herramienta de Exportación de Cookies",
    "exportTab": "Exportar"
  }
};
```

### 4. 添加语言选项

在 [popup.html](../popup.html) 中添加新语言的选项：

```html
<select id="language-selector">
  <!-- 其他选项 -->
  <option value="es" data-i18n="spanish">Español</option>
</select>
```

同时在所有语言的翻译文件中添加 `spanish` 键的翻译。

### 5. 更新语言列表

在 [js/modules/i18n/i18nManager.js](../js/modules/i18n/i18nManager.js) 中更新支持的语言列表：

```javascript
/**
 * 获取支持的语言列表
 * @returns {Array} 支持的语言代码数组
 */
function getSupportedLanguages() {
  return ['zh-CN', 'en', 'fr', 'es'];
}
```

## 最佳实践

### 1. 字符串外部化

所有用户可见的字符串都应外部化到翻译资源文件中，避免硬编码在代码中。

### 2. 一致的键命名

使用一致且有意义的键名，例如使用功能描述作为前缀：
- `exportTab` - 导出标签
- `importTab` - 导入标签
- `exportCurrent` - 导出当前网站
- `copyAll` - 复制全部

### 3. 参数化消息

对于包含动态内容的消息，使用参数化格式：

```json
{
  "importSuccess": {
    "message": "成功导入 $count$ 个 Cookies",
    "placeholders": {
      "count": {
        "content": "$1",
        "example": "10"
      }
    }
  }
}
```

在代码中使用：

```javascript
I18n.formatMessage("importSuccess", [count])
```

### 4. 测试所有语言

确保在所有支持的语言环境下测试界面，检查：
- 文本是否正确翻译
- 布局是否合理（不同语言文本长度可能不同）
- 功能是否正常工作

### 5. 保持同步

当添加新功能或修改界面时，确保：
- 更新所有语言的翻译文件
- 添加新的翻译键
- 删除不再使用的翻译键